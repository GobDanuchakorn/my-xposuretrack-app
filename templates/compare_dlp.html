<!DOCTYPE html>
<html>
<head>
    <title>Compare DLP by Study Description</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; background: #f8fafc; margin: 0; padding: 0; }
        h1 { color: #2a5d8f; }
        h2 { margin-top: 40px; color: #18446b; }
        .container { max-width: 1100px; margin: 30px auto; background: #fff; padding: 32px 32px 24px 32px; border-radius: 10px; box-shadow: 0 2px 8px #0001; }
        .search-box { margin-bottom: 30px; }
        .search-box input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #bbb;
            border-radius: 6px;
            font-size: 1em;
            width: 260px;
        }
        .study-section { margin-bottom: 60px; }
        img { max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 1px 6px #0001; }
        table { border-collapse: collapse; margin: 20px 0; width: 100%; min-width: 600px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th {
            background-color: #e4eefd;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tr:nth-child(even) { background: #f9f9f9; }
        tr:nth-child(odd) { background: #fff; }
        a { color: #2a5d8f; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .nav-links { margin-top: 30px; }
        .nav-links a, .nav-links button {
            margin-right: 18px;
            color: #fff;
            font-weight: bold;
            text-decoration: none;
            background: #2a5d8f;
            border: none;
            padding: 10px 22px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 1em;
            display: inline-block;
        }
        .nav-links a:hover, .nav-links button:hover { background: #18446b; color: #fff; text-decoration: none; }
        .export-btn {
            background: #28a745;
            color: #fff;
            margin-bottom: 24px;
            border: none;
            padding: 10px 22px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s;
            margin-right: 10px;
            margin-top: 8px;
        }
        .export-btn:hover { background: #218838; }
        .export-form {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .export-form select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #bbb;
            font-size: 1em;
        }
        @media (max-width: 800px) {
            .container { padding: 10px 2vw; }
            table, th, td { font-size: 0.97em; min-width: 0; }
        }
        @media (max-width: 600px) {
            .export-btn, .nav-links a, .nav-links button, .export-form select { width: 100%; margin-bottom: 10px; }
            .export-form { flex-direction: column; align-items: stretch; }
        }
    </style>
    <script>
    function filterStudies() {
        var input = document.getElementById('studySearch');
        var filter = input.value.toLowerCase();
        var sections = document.getElementsByClassName('study-section');
        for (var i = 0; i < sections.length; i++) {
            var title = sections[i].getElementsByTagName('h2')[0];
            if (title.innerText.toLowerCase().indexOf(filter) > -1) {
                sections[i].style.display = '';
            } else {
                sections[i].style.display = 'none';
            }
        }
    }
    </script>
</head>
<body>
    <div class="container">
        <h1>Total DLP Comparison by Study Description</h1>
        <!-- Export to Excel for selected study -->
        <form action="{{ url_for('export_excel_filtered') }}" method="get" class="export-form">
            <label for="study_desc" style="font-weight:bold;">Select Study:</label>
            <select name="study_desc" id="study_desc" required>
                {% for study in study_descriptions %}
                    <option value="{{ study }}" {% if study == selected_study %}selected{% endif %}>{{ study }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="export-btn">‚¨áÔ∏è Export to Excel</button>
        </form>
        <div class="search-box">
            <input type="text" id="studySearch" onkeyup="filterStudies()" placeholder="Filter by Study Description...">
        </div>
        {% if plots %}
            {% for plot, table in zip(plots, tables) %}
            <div class="study-section" id="{{ plot.study|replace(' ', '_') }}">
                <h2>{{ plot.study }}</h2>
                <img src="{{ url_for('static', filename=plot.plot_url.split('static/')[1]) }}" alt="DLP Comparison Plot for {{ plot.study }}">
                <h3>Data Table</h3>
                <table>
                    <thead>
                    <tr>
                        <th>Patient ID</th>
                        <th>Study Date</th>
                        <th>Total DLP (mGy¬∑cm)</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for row in table.table %}
                    <tr>
                        <td>
                            {% if row['report_id'] %}
                            <a href="{{ url_for('view_report', report_id=row['report_id']) }}">{{ row['Patient ID'] }}</a>
                            {% else %}
                            {{ row['Patient ID'] }}
                            {% endif %}
                        </td>
                        <td>{{ row['study_date'] }}</td>
                        <td>{{ row['Total DLP'] }}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}
        {% else %}
            <p>No studies with DLP data found.</p>
        {% endif %}
        <div class="nav-links">
            <!-- ‡∏õ‡∏∏‡πà‡∏° Upload More Files -->
            <form id="uploadForm" action="{{ url_for('process_files') }}" method="post" enctype="multipart/form-data" style="display:inline;">
                <input type="file" name="files" id="fileInput" multiple style="display:none;" onchange="document.getElementById('uploadForm').submit();">
                <button type="button" onclick="document.getElementById('fileInput').click();" class="nav-links-btn">üì§ Upload More Files</button>
            </form>
            <a href="/">Back to Modality Selection</a>
        </div>
    </div>
</body>
</html>
