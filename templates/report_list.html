<!DOCTYPE html>
<html>
<head>
    <title>Uploaded {{ current_modality or 'All' }} Dose Reports - Page {{ page }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 20px auto; background: #fff; padding: 25px 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
        
        h1 { 
            margin-top: 0; 
            color: #1a4a73; /* Darker blue */
            font-size: 2em;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .sub-header { font-size: 0.9em; color: #555; margin-top: -15px; margin-bottom: 20px; }

        .top-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;}
        .nav-links { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
        .nav-links a, .nav-links .btn-like-link { 
            font-weight: 600; 
            color: #007bff; /* Bootstrap primary blue */
            text-decoration: none; 
            padding: 8px 15px;
            border-radius: 6px;
            transition: background-color 0.2s, color 0.2s;
            border: 1px solid transparent;
        }
        .nav-links a:hover, .nav-links .btn-like-link:hover { 
            background-color: #e7f3ff; 
            color: #0056b3;
            text-decoration: none;
        }
        .nav-links a i, .nav-links .btn-like-link i { margin-right: 6px; }

        #uploadForm { display: inline-block; margin: 0; }
        #fileInput { display: none; }
        .upload-btn {
            background-color: #28a745; /* Green */
            color: white;
            padding: 9px 18px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .upload-btn:hover { background-color: #218838; }
        .upload-btn i { margin-right: 6px; }

        .search-filter-section { margin-bottom: 25px; padding: 15px; background-color: #f8f9fa; border-radius: 8px; }
        .search-box { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .search-box input[type="text"], .search-box select {
            padding: 9px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.95em;
            flex-grow: 1; min-width: 200px;
        }
        .search-box button {
            padding: 9px 18px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95em;
            transition: background-color 0.2s;
        }
        .search-box button:hover { background-color: #0056b3; }
        .search-box button i { margin-right: 6px; }
        
        .report-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin: 0; padding: 0; list-style: none; }
        .report-card {
            background: #fff;
            border: 1px solid #e3e3e3;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 20px;
            transition: box-shadow 0.25s ease-in-out, transform 0.25s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Key for aligning actions to bottom */
            min-height: 220px; /* Ensure cards have a minimum height */
        }
        .report-card:hover {
            box-shadow: 0 6px 18px rgba(0,0,0,0.1);
            transform: translateY(-3px);
        }
        .card-header-info { margin-bottom: 12px; }
        .report-title { 
            font-weight: 600; 
            font-size: 1.15em; 
            color: #1a4a73; 
            margin-bottom: 6px;
            word-break: break-word; /* Allow long titles to wrap */
        }
         .report-subtitle {
            color: #555;
            font-size: 0.9em; /* Slightly increased size */
            margin-bottom: 8px; /* Increased spacing */
            word-break: break-word;
        }
        .report-meta { 
            font-size: 0.9em; /* Increased base size */
            color: #555; 
            margin-bottom: 12px; 
            flex-grow: 1; /* Allows this section to take up available space */
        }
        .report-meta div { 
            margin-bottom: 5px; /* Consistent spacing for meta items */
            display: flex; /* For aligning icon and text */
            align-items: center; /* Vertically align icon and text */
        }
        .report-meta strong { 
            color: #333; 
            margin-left: 5px; /* Space after icon */
            margin-right: 5px; /* Space before colon if used */
            white-space: nowrap; /* Prevent label from wrapping */
        } 
        .report-meta i { 
            margin-right: 6px; /* Space after icon */
            color: #007bff; /* Consistent icon color */
            width: 16px; /* Fixed width for icons for alignment */
            text-align: center;
        }
        .report-meta span.value { /* Class for the value part */
            word-break: break-word; /* Allow long values to wrap */
        }


        .card-actions {
            display: flex;
            justify-content: space-between; /* Pushes items to ends */
            align-items: center;
            gap: 10px;
            margin-top: 15px; /* Auto margin pushes to bottom if flex-grow is on content */
            border-top: 1px solid #f0f0f0;
            padding-top: 12px;
        }
        .view-link {
            color: #007bff;
            background-color: #e7f3ff;
            text-decoration: none;
            font-weight: 600;
            padding: 7px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            transition: background-color 0.2s, color 0.2s;
            flex-grow: 1; text-align: center; /* Make view link take more space */
        }
        .view-link:hover { background-color: #cce5ff; color: #004085; }
        .view-link i { margin-right: 5px; }

        .delete-btn-form { display: inline-block; } /* To keep button on same line */
        .delete-btn {
            background-color: #dc3545; /* Red */
            color: white;
            border: none;
            padding: 7px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .delete-btn:hover { background-color: #c82333; }
        .delete-btn i { margin-right: 0; } 
        
        .pagination { margin: 30px 0; text-align: center; }
        .pagination a, .pagination span {
            margin: 0 4px;
            padding: 8px 14px;
            text-decoration: none;
            border: 1px solid #dee2e6;
            color: #007bff;
            border-radius: 5px;
            transition: background-color 0.2s, color 0.2s;
        }
        .pagination a:hover { background-color: #e9ecef; color: #0056b3; }
        .pagination .active {
            background-color: #007bff;
            color: #fff;
            border-color: #007bff;
            pointer-events: none;
        }
        .pagination .disabled {
            color: #6c757d;
            border-color: #dee2e6;
            pointer-events: none;
        }
        
        .comparison-links-section { margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 8px;}
        .comparison-links-section h3 { margin-top: 0; color: #1a4a73; }
        .comparison-links-section ul { padding-left: 0; list-style: none; margin: 0; }
        .comparison-links-section li { margin-bottom: 8px; }
        .comparison-links-section a { 
            text-decoration: none; 
            color: #007bff;
            font-weight: 500;
            display: block;
            padding: 8px 0;
        }
        .comparison-links-section a:hover { color: #0056b3; text-decoration: underline; }
        .comparison-links-section a i { margin-right: 8px; }

        .no-reports { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center; }
        
        .flash-messages { list-style-type: none; padding: 0; margin-bottom: 20px; }
        .flash-messages li { padding: 12px 18px; margin-bottom: 10px; border-radius: 6px; font-size: 0.95em; }
        .flash-messages .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
        .flash-messages .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
        .flash-messages .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;}
        .flash-messages .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;}

        .back-to-modality-selection {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 18px;
            background-color: #6c757d; /* Secondary grey */
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .back-to-modality-selection:hover { background-color: #5a6268; }
        .back-to-modality-selection i { margin-right: 6px; }

        @media (max-width: 768px) {
            .report-list { grid-template-columns: 1fr; } 
            .top-actions { flex-direction: column; align-items: stretch; }
            .search-box { flex-direction: column; align-items: stretch; }
            .search-box input[type="text"], .search-box select, .search-box button { width: 100%; }
            .nav-links { justify-content: center; }
            h1 { font-size: 1.6em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <i class="fas fa-folder-open"></i> Uploaded {{ current_modality or 'All' }} Dose Reports
        </h1>
        <p class="sub-header">
            {% if total > 0 %}
                Currently viewing page {{ page }} of {{ pages }}. Total {{ current_modality or '' }} reports: {{ total }}
            {% else %}
                No {{ current_modality or '' }} reports found.
            {% endif %}
        </p>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <ul class="flash-messages">
                {% for category, message in messages %}
                <li class="{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
            {% endif %}
        {% endwith %}

        <div class="top-actions">
            <div class="nav-links">
                <a href="{{ url_for('search_patient') }}" class="btn-like-link"><i class="fas fa-user-magnifying-glass"></i> Patient Search ({{current_modality or 'Any'}})</a>
                {% if current_modality == 'CT' and reports %}
                    <a href="{{ url_for('compare_dlp') }}" class="btn-like-link"><i class="fas fa-chart-line"></i> Compare CT DLP</a>
                {% elif current_modality == 'DX' and reports %}
                    <a href="{{ url_for('compare_dap') }}" class="btn-like-link"><i class="fas fa-chart-bar"></i> Compare DX DAP</a>
                {% endif %}
            </div>
            <form id="uploadForm" action="{{ url_for('process_files') }}" method="post" enctype="multipart/form-data">
                <input type="file" name="files" id="fileInput" multiple onchange="document.getElementById('uploadForm').submit();" accept=".dcm">
                <button type="button" class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-upload"></i> Upload More {{ current_modality or '' }} Files
                </button>
            </form>
        </div>

        <div class="search-filter-section">
            <form method="get" class="search-box">
                <input type="text" name="search" placeholder="Search filename, Patient ID, Study Date (YYYY-MM-DD), {{ 'Study Desc...' if current_modality == 'CT' else 'Body Part...' }}" value="{{ search or '' }}">
                <button type="submit"><i class="fas fa-search"></i> Search</button>
            </form>
        </div>

        {% if reports %}
        <ul class="report-list">
            {% for report in reports %}
            <li class="report-card">
                <div> {# This div helps with flex layout for content vs actions #}
                    <div class="card-header-info">
                        {% if current_modality == 'CT' %}
                            <div class="report-title">{{ report.study_description or 'N/A Study Description' }}</div>
                            <div class="report-subtitle">Series: {{ report.series_description or 'N/A' }}</div>
                        {% elif current_modality == 'DX' %}
                            <div class="report-title">{{ report.body_part or 'N/A Body Part' }}</div>
                            <div class="report-subtitle">View: {{ report.view_position or 'N/A' }}</div>
                        {% else %}
                             <div class="report-title">{{ report.filename }}</div>
                        {% endif %}
                    </div>
<div class="report-meta">
                        <div><i class="fas fa-file-alt"></i><strong>File:</strong> <span class="value">{{ report.filename | truncate(25, True) }}</span></div>
                        <div><i class="fas fa-id-card"></i><strong>Patient ID :</strong> <span class="value">{{ report['Patient ID'] or 'N/A' }}</span></div>
                        <div><i class="fas fa-calendar-alt"></i><strong>Study Date :</strong> <span class="value">{{ report['Study Date'] or 'N/A' }}</span></div>
                        
                        {% if current_modality == 'DX' and report.dap_value_ugy_m2 %}
                            {% set dap_val_for_check = report.dap_value_ugy_m2|string|lower %}
                            {% if dap_val_for_check != 'n/a' and not dap_val_for_check.startswith('n/a (') %}
                                <div>
                                    <i class="fas fa-radiation"></i> <strong>DAP:</strong> 
                                    <span class="value">
                                    {% set dap_display_val = report.dap_value_ugy_m2 %}
                                    {# Attempt to format as float if it looks like a number #}
                                    {% if dap_display_val is number %}
                                        {{ "%.2f"|format(dap_display_val) }}
                                    {% elif dap_display_val is string %}
                                        {% set temp_val = dap_display_val.replace('.', '', 1) %}
                                        {% if temp_val.startswith('-') %}{% set temp_val = temp_val[1:] %}{% endif %}
                                        {% if temp_val.isdigit() %}
                                            {{ "%.2f"|format(dap_display_val|float) }}
                                        {% else %}
                                            {{ dap_display_val }} {# Display as is if not a simple number string #}
                                        {% endif %}
                                    {% else %}
                                         {{ dap_display_val }} {# Fallback for other types, though unlikely #}
                                    {% endif %}
                                     µGy·m²
                                    </span>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                <div class="card-actions">
                    <a class="view-link" href="{{ url_for('view_report', report_id=report.id) }}" title="View report details for {{ report.filename }}">
                        <i class="fas fa-eye"></i> View Details
                    </a>
                    <form class="delete-btn-form" action="{{ url_for('delete_file', report_id=report.id) }}" method="post">
                        <input type="hidden" name="page" value="{{ page }}">
                        <input type="hidden" name="search" value="{{ search or '' }}">
                        <button type="submit" class="delete-btn" title="Delete {{ report.filename }}" onclick="return confirm('Are you sure you want to delete file: {{ report.filename }}?')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </form>
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
            <div class="no-reports">
                {% if search %}
                    No reports found matching your search criteria for "{{ search }}".
                {% else %}
                    No {{ current_modality or ''}} reports uploaded yet. Try uploading some files.
                {% endif %}
            </div>
        {% endif %}

        {% if pages > 1 %}
        <div class="pagination">
            {# Previous Page Link #}
            {% if page > 1 %}
                <a href="{{ url_for('list_reports', page=1, search=search) }}">&laquo; First</a>
                <a href="{{ url_for('list_reports', page=page-1, search=search) }}">&lsaquo; Prev</a>
            {% else %}
                <span class="disabled">&laquo; First</span>
                <span class="disabled">&lsaquo; Prev</span>
            {% endif %}

            {# Page Number Links - More intelligent pagination #}
            {% set window = 1 %} {# How many pages to show around current page #}
            {% set show_first_ellipsis = false %}
            {% set show_last_ellipsis = false %}

            {% for p in range(1, pages + 1) %}
                {% if p == page %}
                    <span class="active">{{ p }}</span>
                {% elif p == 1 or p == pages or (p >= page - window and p <= page + window) %}
                    <a href="{{ url_for('list_reports', page=p, search=search) }}">{{ p }}</a>
                {% elif p < page and not show_first_ellipsis and p > 1 %}
                    {% set show_first_ellipsis = true %}
                    <span class="disabled">&hellip;</span>
                {% elif p > page and not show_last_ellipsis and p < pages %}
                    {% set show_last_ellipsis = true %}
                    <span class="disabled">&hellip;</span>
                {% endif %}
            {% endfor %}

            {# Next Page Link #}
            {% if page < pages %}
                <a href="{{ url_for('list_reports', page=page+1, search=search) }}">Next &rsaquo;</a>
                <a href="{{ url_for('list_reports', page=pages, search=search) }}">Last &raquo;</a>
            {% else %}
                <span class="disabled">Next &rsaquo;</span>
                <span class="disabled">Last &raquo;</span>
            {% endif %}
        </div>
        {% endif %}

        {# Modality-specific Comparison Links #}
        {% if (current_modality == 'CT' and study_descriptions) or (current_modality == 'DX' and body_parts_examined) %}
        <div class="comparison-links-section">
            <h3><i class="fas fa-link"></i> Quick Links to {{current_modality}} Comparisons</h3>
            <ul>
                {% if current_modality == 'CT' %}
                    {% for study in study_descriptions %}
                    <li>
                        <a href="{{ url_for('compare_dlp', study_desc_filter=study) }}"><i class="fas fa-chart-line"></i> {{ study }}</a>
                    </li>
                    {% endfor %}
                    {% if not study_descriptions %}
                     <li>No specific CT study types identified for quick comparison links.</li>
                    {% endif %}
                {% elif current_modality == 'DX' %}
                    {% for bp in body_parts_examined %}
                    <li>
                        <a href="{{ url_for('compare_dap', body_part_filter=bp) }}"><i class="fas fa-chart-bar"></i> {{ bp }}</a>
                    </li>
                    {% endfor %}
                    {% if not body_parts_examined %}
                     <li>No specific DX body parts identified for quick comparison links.</li>
                    {% endif %}
                {% endif %}
            </ul>
        </div>
        {% endif %}
        
        <a href="{{ url_for('select_modality') }}" class="back-to-modality-selection">
            <i class="fas fa-arrow-left"></i> Change Modality / Back to Home
        </a>

    </div>
    </body>
</html>